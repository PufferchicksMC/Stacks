services:
  mc:
    container_name: craftoria-dev
    image: itzg/minecraft-server:java25-graalvm
    restart: unless-stopped
    user: ${UID}:${GID}
    tty: true
    stdin_open: true
    depends_on:
      - nginx
      - db
    networks:
      default:
      proxy:
        aliases:
          - mc-craftoria-dev
    ports:
      - name: simplevoicechat
        target: 24454
        published: 24455
        protocol: udp
    volumes:
      - type: bind
        source: /opt/minecraft/servers/craftoria-dev
        target: /data
      - type: bind
        source: ./extras
        target: /extras
        read_only: true
    env_file:
      - path: ./.env
        required: true
    environment:
      VERSION: 1.21.1
      TYPE: Neoforge
      NEOFORGE_VERSION: 21.1.215
      MODE: creative
      SEED: 123
      MEMORY: 8G
      MOTD: |
        A %TYPE% server on %VERSION%
        running %MODPACK_NAME% %MODPACK_VERSION%
      RCON_CMDS_STARTUP: |
        gamerule doFireTick false
        gamerule playerSleepingPercentage 0
      MODRINTH_PROJECTS: "@/extras/modrinth-mods.txt"
      MODRINTH_DOWNLOAD_DEPENDENCIES: required
      APPLY_EXTRA_FILES: |
        bluemap/mariadb-java-client-3.5.4.jar<https://share.lxnq.to/-XWzKV9xmg9/mariadb-java-client-3.5.4.jar
    labels:
      mc-router.host: craftoria-dev.off-topic.chat
      mc-router.network: ovh-proxy_default

  nginx:
    image: webdevops/php-nginx:8.4-alpine
    restart: unless-stopped
    networks:
      default:
      proxy:
        aliases:
          - bm-craftoria-dev
    volumes:
      - type: bind
        source: ./vhost.conf
        target: /opt/docker/etc/nginx/vhost.conf
        read_only: true
      - type: bind
        source: /opt/minecraft/servers/craftoria-dev/bluemap/web
        target: /app/bluemap
        read_only: true
    labels:
      traefik.http.routers.craftoria-dev-bluemap.rule: Host(`bluemap.off-topic.chat`) && PathPrefix(`craftoria-dev`)
      traefik.http.services.craftoria-dev-bluemap.loadbalancer.server.url: http://bm-craftoria-dev:80

  db:
    image: mariadb:11
    restart: unless-stopped
    volumes:
      - type: volume
        source: db
        target: /var/lib/mysql
    environment:
      MARIADB_RANDOM_ROOT_PASSWORD: 1
      MARIADB_DATABASE: ${CFG_DB_NAME}
      MARIADB_USER: ${CFG_DB_USER}
      MARIADB_PASSWORD: ${CFG_DB_PASSWORD}

volumes:
  db: null

networks:
  default:
  proxy:
    name: ovh-proxy_default
    external: true