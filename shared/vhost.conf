server {
  listen 80;
  server_name _;
  root /app/bluemap;
  charset utf-8;
  resolver 127.0.0.11 valid=30s;
  
  location / {
    try_files $uri /sql.php;
  }

  # Serve offline fallback for the map
  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  }
  
  # Proxy requests to the live map
  location ~* /(maps/[^/\s]*/live/.*) {
    proxy_pass http://mc-create:8100/$1;
  }

  access_log off;
  error_log /dev/null;
}

server {
  listen 81;
  server_name _;
  root /app/backup;
  charset utf-8;

  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header X-Content-Type-Options "nosniff" always;

  location / {
    try_files $uri $uri/ =404;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
    autoindex_format html;
  }

  location ~* \.tgz$ {
    add_header Content-Type "application/gzip";
    add_header Content-Disposition "attachment;";
    tcp_nopush on;
    tcp_nodelay off;
    sendfile on;
    sendfile_max_chunk 1m;
  }

  access_log off;
  error_log /dev/null;
}

server {
  listen 82;
  server_name _;
  root /app/modpack;
  charset utf-8;

  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Access-Control-Allow-Origin "*" always;
  add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
  add_header Access-Control-Allow-Headers "Range, If-Range, If-Modified-Since" always;

  location / {
    try_files $uri $uri/ =404;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
    autoindex_format html;
  }

  location ~* ^/[^/]+/pack\.toml$ {
    add_header Content-Type "text/plain; charset=utf-8";
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
  }

  location ~* \.(cfg|conf|js|json|json5|md|toml|txt|yml)$ {
    add_header Content-Type "text/plain; charset=utf-8";
  }

  location ~* LICENSE$ {
    add_header Content-Type "text/plain; charset=utf-8";
  }

  access_log off;
  error_log /dev/null;
}